var AuthService_1;
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { BehaviorSubject, ReplaySubject } from 'rxjs';
export class AuthServiceConfig {
    constructor(providers) {
        this.lazyLoad = false;
        this.providers = new Map();
        for (let i = 0; i < providers.length; i++) {
            let element = providers[i];
            this.providers.set(element.id, element.provider);
            this.lazyLoad = this.lazyLoad || element.lazyLoad;
        }
    }
}
let AuthService = AuthService_1 = class AuthService {
    constructor(config) {
        this._user = null;
        this._authState = new ReplaySubject(1);
        this._readyState = new BehaviorSubject([]);
        this.initialized = false;
        this.providers = config.providers;
        if (!config.lazyLoad) {
            this.initialize();
        }
    }
    get authState() {
        return this._authState.asObservable();
    }
    /** Provides an array of provider ID's as they become ready */
    get readyState() {
        return this._readyState.asObservable();
    }
    initialize() {
        this.initialized = true;
        this.providers.forEach((provider, key) => {
            provider.initialize().then(() => {
                let readyProviders = this._readyState.getValue();
                readyProviders.push(key);
                this._readyState.next(readyProviders);
                provider.getLoginStatus().then((user) => {
                    user.provider = key;
                    this._user = user;
                    this._authState.next(user);
                }).catch((err) => {
                    this._authState.next(null);
                });
            });
        });
    }
    signIn(providerId, opt) {
        if (!this.initialized) {
            this.initialize();
        }
        return new Promise((resolve, reject) => {
            let providerObject = this.providers.get(providerId);
            if (providerObject) {
                providerObject.signIn(opt).then((user) => {
                    user.provider = providerId;
                    resolve(user);
                    this._user = user;
                    this._authState.next(user);
                }).catch(err => {
                    reject(err);
                });
            }
            else {
                reject(AuthService_1.ERR_LOGIN_PROVIDER_NOT_FOUND);
            }
        });
    }
    signOut(revoke = false) {
        if (!this.initialized) {
            this.initialize();
        }
        return new Promise((resolve, reject) => {
            if (!this._user) {
                reject(AuthService_1.ERR_NOT_LOGGED_IN);
            }
            else {
                let providerId = this._user.provider;
                let providerObject = this.providers.get(providerId);
                if (providerObject) {
                    providerObject.signOut(revoke).then(() => {
                        resolve();
                        this._user = null;
                        this._authState.next(null);
                    }).catch((err) => {
                        reject(err);
                    });
                }
                else {
                    reject(AuthService_1.ERR_LOGIN_PROVIDER_NOT_FOUND);
                }
            }
        });
    }
};
AuthService.ERR_LOGIN_PROVIDER_NOT_FOUND = 'Login provider not found';
AuthService.ERR_NOT_LOGGED_IN = 'Not logged in';
AuthService.ctorParameters = () => [
    { type: AuthServiceConfig }
];
AuthService = AuthService_1 = tslib_1.__decorate([
    Injectable()
], AuthService);
export { AuthService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhcngtc29jaWFsLWxvZ2luLyIsInNvdXJjZXMiOlsibGliL2F1dGguc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFjLGVBQWUsRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFpRmxFLE1BQU0sT0FBTyxpQkFBaUI7SUFJNUIsWUFBWSxTQUFrQztRQUg5QyxhQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLGNBQVMsR0FBK0IsSUFBSSxHQUFHLEVBQXlCLENBQUM7UUFHdkUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDekMsSUFBSSxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDO1NBQ25EO0lBQ0gsQ0FBQztDQUNGO0FBR0QsSUFBYSxXQUFXLG1CQUF4QixNQUFhLFdBQVc7SUFxQnRCLFlBQVksTUFBeUI7UUFkN0IsVUFBSyxHQUFlLElBQUksQ0FBQztRQUN6QixlQUFVLEdBQThCLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzdELGdCQUFXLEdBQThCLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWpFLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBVzFCLElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQztRQUVsQyxJQUFJLENBQUMsTUFBTSxDQUFD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O2dCQUNMLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO2dCQUNyQyxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDcEQsSUFBSSxjQUFjLEVBQUU7b0JBQ2xCLGNBQWMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTt3QkFDdkMsT0FBTyxFQUFFLENBQUM7d0JBRVYsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7d0JBQ2xCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUM3QixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTt3QkFDZixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2QsQ0FBQyxDQUFDLENBQUM7aUJBQ0o7cUJBQU07b0JBQ0wsTUFBTSxDQUFDLGFBQVcsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO2lCQUNsRDthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBRUYsQ0FBQTtBQWhHeUIsd0NBQTRCLEdBQUcsMEJBQTBCLENBQUM7QUFDMUQsNkJBQWlCLEdBQUcsZUFBZSxDQUFDOztZQWtCeEMsaUJBQWlCOztBQXJCMUIsV0FBVztJQUR2QixVQUFVLEVBQUU7R0FDQSxXQUFXLENBa0d2QjtTQWxHWSxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0LCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBMb2dpblByb3ZpZGVyIH0gZnJvbSAnLi9lbnRpdGllcy9sb2dpbi1wcm92aWRlcic7XHJcbmltcG9ydCB7IFNvY2lhbFVzZXIgfSBmcm9tICcuL2VudGl0aWVzL3VzZXInO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBBdXRoU2VydmljZUNvbmZpZ0l0ZW0ge1xyXG4gIGlkOiBzdHJpbmc7XHJcbiAgcHJvdmlkZXI6IExvZ2luUHJvdmlkZXI7XHJcbiAgLyoqXHJcbiAgICogVGhpcyBmaWVsZCBhbGxvd3MgdG8gbG9hZCBsb2dpbiBwcm92aWRlcnMgU0RLcyBsYXppbHkuXHJcbiAgICogTGF6eSBsb2FkaW5nIGlzIGFjdGl2YXRlZCBpZiBpdCdzIHRydWUgYW5kIHZpY2UgdmVyc2EuXHJcbiAgICovXHJcbiAgbGF6eUxvYWQ/OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIExvZ2luT3B0IHtcclxuICAvKipcclxuICAgKiBGYWNlYm9vayBGQi5sb2dpbiBvcHRpb25zOiBodHRwczovL2RldmVsb3BlcnMuZmFjZWJvb2suY29tL2RvY3MvcmVmZXJlbmNlL2phdmFzY3JpcHQvRkIubG9naW4vdjIuMTEuXHJcbiAgICovXHJcbiAgYXV0aF90eXBlPzogc3RyaW5nOyAvLyBPcHRpb25hbCBrZXksIG9ubHkgc3VwcG9ydHMgb25lIHZhbHVlOiByZXJlcXVlc3QuIFVzZSB0aGlzIHdoZW4gcmUtcmVxdWVzdGluZyBhIGRlY2xpbmVkIHBlcm1pc3Npb24uXHJcbiAgc2NvcGU/OiBzdHJpbmc7IC8vIENvbW1hIHNlcGFyYXRlZCBsaXN0IG9mIGV4dGVuZGVkIHBlcm1pc3Npb25zXHJcbiAgcmV0dXJuX3Njb3Blcz86IGJvb2xlYW47IC8vIFdoZW4gdHJ1ZSwgdGhlIGdyYW50ZWQgc2NvcGVzIHdpbGwgYmUgcmV0dXJuZWQgaW4gYSBjb21tYS1zZXBhcmF0ZWQgbGlzdC5cclxuICBlbmFibGVfcHJvZmlsZV9zZWxlY3Rvcj86IGJvb2xlYW47IC8vIFdoZW4gdHJ1ZSwgcHJvbXB0IHRoZSB1c2VyIHRvIGdyYW50IHBlcm1pc3Npb24gZm9yIG9uZSBvciBtb3JlIFBhZ2VzLlxyXG4gIHByb2ZpbGVfc2VsZWN0b3JfaWRzPzogc3RyaW5nOyAvLyBDb21tYSBzZXBhcmF0ZWQgbGlzdCBvZiBJRHMgdG8gZGlzcGxheSBpbiB0aGUgcHJvZmlsZSBzZWxlY3RvclxyXG4gIC8qKlxyXG4gICAqIEdvb2dsZSBnYXBpLmF1dGgyLkNsaWVudENvbmZpZzogXFxcclxuICAgKiBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9hcGktY2xpZW50LWxpYnJhcnkvamF2YXNjcmlwdC9yZWZlcmVuY2UvcmVmZXJlbmNlZG9jcyNnYXBpYXV0aDJjbGllbnRjb25maWcuXHJcbiAgICovXHJcbiAgLyogUmVxdWlyZWQuIFRoZSBhcHAncyBjbGllbnQgSUQsIGZvdW5kIGFuZCBjcmVhdGVkIGluIHRoZSBHb29nbGUgRGV2ZWxvcGVycyBDb25zb2xlLiovXHJcbiAgY2xpZW50X2lkPzogc3RyaW5nO1xyXG4gIC8qIFRoZSBkb21haW5zIGZvciB3aGljaCB0byBjcmVhdGUgc2lnbi1pbiBjb29raWVzLiBFaXRoZXIgYSBVUkksXHJcbiAgc2luZ2xlX2hvc3Rfb3JpZ2luLCBvciBub25lLiBEZWZhdWx0cyB0byBzaW5nbGVfaG9zdF9vcmlnaW4gaWYgdW5zcGVjaWZpZWQuICovXHJcbiAgY29va2llX3BvbGljeT86IHN0cmluZztcclxuICAvKiBGZXRjaCB1c2VycycgYmFzaWMgcHJvZmlsZSBpbmZvcm1hdGlvbiB3aGVuIHRoZXkgc2lnbiBpbi4gQWRkcyAncHJvZmlsZScsXHJcbiAgJ2VtYWlsJyBhbmQgJ29wZW5pZCcgdG8gdGhlIHJlcXVlc3RlZCBzY29wZXMuIFRydWUgaWYgdW5zcGVjaWZpZWQuICovXHJcbiAgZmV0Y2hfYmFzaWNfcHJvZmlsZT86IGJvb2xlYW47XHJcbiAgLyogVGhlIEcgU3VpdGUgZG9tYWluIHRvIHdoaWNoIHVzZXJzIG11c3QgYmVsb25nIHRvIHNpZ24gaW4uXHJcbiAgVGhpcyBpcyBzdXNjZXB0aWJsZSB0byBtb2RpZmljYXRpb24gYnkgY2xpZW50cywgc28gYmUgc3VyZSB0byB2ZXJpZnlcclxuICB0aGUgaG9zdGVkIGRvbWFpbiBwcm9wZXJ0eSBvZiB0aGUgcmV0dXJuZWQgdXNlci5cclxuICBVc2UgR29vZ2xlVXNlci5nZXRIb3N0ZWREb21haW4oKSBvbiB0aGUgY2xpZW50LCBhbmQgdGhlIGhkIGNsYWltIGluXHJcbiAgdGhlIElEIFRva2VuIG9uIHRoZSBzZXJ2ZXIgdG8gdmVyaWZ5IHRoZSBkb21haW4gaXMgd2hhdCB5b3UgZXhwZWN0ZWQuICovXHJcbiAgaG9zdGVkX2RvbWFpbj86IHN0cmluZztcclxuICAvKiBVc2VkIG9ubHkgZm9yIE9wZW5JRCAyLjAgY2xpZW50IG1pZ3JhdGlvbi4gU2V0IHRvIHRoZSB2YWx1ZVxyXG4gIG9mIHRoZSByZWFsbSB0aGF0IHlvdSBhcmUgY3VycmVudGx5IHVzaW5nIGZvciBPcGVuSUQgMi4wLFxyXG4gIGFzIGRlc2NyaWJlZCBpbiBPcGVuSUQgMi4wIChNaWdyYXRpb24pLiAqL1xyXG4gIG9wZW5pZF9yZWFsbT86IHN0cmluZztcclxuICAvKiBUaGUgVVggbW9kZSB0byB1c2UgZm9yIHRoZSBzaWduLWluIGZsb3cuIEJ5IGRlZmF1bHQsIGl0IHdpbGwgb3BlbiB0aGUgY29uc2VudCBmbG93IGluIGEgcG9wdXAuIFZhbGlkIHZhbHVlcyBhcmUgcG9wdXAgYW5kIHJlZGlyZWN0LiAqL1xyXG4gIHV4X21vZGU/OiBzdHJpbmc7XHJcbiAgLyogSWYgdXNpbmcgdXhfbW9kZT0ncmVkaXJlY3QnLCB0aGlzIHBhcmFtZXRlciBhbGxvd3MgeW91IHRvIG92ZXJyaWRlXHJcbiAgdGhlIGRlZmF1bHQgcmVkaXJlY3RfdXJpIHRoYXQgd2lsbCBiZSB1c2VkIGF0IHRoZSBlbmQgb2YgdGhlIGNvbnNlbnQgZmxvdy5cclxuICBUaGUgZGVmYXVsdCByZWRpcmVjdF91cmkgaXMgdGhlIGN1cnJlbnQgVVJMIHN0cmlwcGVkIG9mIHF1ZXJ5IHBhcmFtZXRlcnNcclxuICBhbmQgaGFzaCBmcmFnbWVudC4gKi9cclxuICByZWRpcmVjdF91cmk/OiBzdHJpbmc7XHJcbiAgLyogR2V0IHBlcm1pc3Npb24gZnJvbSB0aGUgdXNlciB0byBhY2Nlc3MgdGhlIHNwZWNpZmllZCBzY29wZXMgb2ZmbGluZSxcclxuICAgKiBJZiB1c2luZyBvZmZsaW5lX2FjY2Vzcz10cnVlLCBHb29nbGVBdXRoLmdyYW50T2ZmbGluZUFjY2VzcygpIHdpbGwgYmUgdXNlIGluc3RlYWQgb2YgR29vZ2xlQXV0aC5zaWduSW4oKVxyXG4gICAqL1xyXG4gIG9mZmxpbmVfYWNjZXNzPzogYm9vbGVhbjtcclxuICAvKlxyXG4gICBBIHNwYWNlLWRlbGltaXRlZCBsaXN0IG9mIHN0cmluZyB2YWx1ZXMgdGhhdCBzcGVjaWZpZXMgd2hldGhlciB0aGUgYXV0aG9yaXphdGlvbiBzZXJ2ZXIgcHJvbXB0cyB0aGUgdXNlciBmb3IgcmVhdXRoZW50aWNhdGlvblxyXG4gICBhbmQgY29uc2VudC4gVGhlIHBvc3NpYmxlIHZhbHVlcyBhcmU6XHJcbiAgICBub25lXHJcbiAgICAgIFRoZSBhdXRob3JpemF0aW9uIHNlcnZlciBkb2VzIG5vdCBkaXNwbGF5IGFueSBhdXRoZW50aWNhdGlvbiBvciB1c2VyIGNvbnNlbnQgc2NyZWVuczsgaXQgd2lsbCByZXR1cm4gYW4gZXJyb3IgaWYgdGhlIHVzZXIgaXMgbm90XHJcbiAgICAgIGFscmVhZHkgYXV0aGVudGljYXRlZCBhbmQgaGFzIG5vdCBwcmUtY29uZmlndXJlZCBjb25zZW50IGZvciB0aGUgcmVxdWVzdGVkIHNjb3Blcy4gWW91IGNhbiB1c2Ugbm9uZSB0byBjaGVjayBmb3IgZXhpc3RpbmdcclxuICAgICAgYXV0aGVudGljYXRpb24gYW5kL29yIGNvbnNlbnQuXHJcbiAgICBjb25zZW50XHJcbiAgICAgIFRoZSBhdXRob3JpemF0aW9uIHNlcnZlciBwcm9tcHRzIHRoZSB1c2VyIGZvciBjb25zZW50IGJlZm9yZSByZXR1cm5pbmcgaW5mb3JtYXRpb24gdG8gdGhlIGNsaWVudC5cclxuICAgIHNlbGVjdF9hY2NvdW50XHJcbiAgICAgIFRoZSBhdXRob3JpemF0aW9uIHNlcnZlciBwcm9tcHRzIHRoZSB1c2VyIHRvIHNlbGVjdCBhIHVzZXIgYWNjb3VudC4gVGhpcyBhbGxvd3MgYSB1c2VyIHdobyBoYXMgbXVsdGlwbGUgYWNjb3VudHMgYXQgdGhlIGF1dGhvcml6YXRpb25cclxuICAgICAgc2VydmVyIHRvIHNlbGVjdCBhbW9uZ3N0IHRoZSBtdWx0aXBsZSBhY2NvdW50cyB0aGF0IHRoZXkgbWF5IGhhdmUgY3VycmVudCBzZXNzaW9ucyBmb3IuXHJcblxyXG4gICBJZiBubyB2YWx1ZSBpcyBzcGVjaWZpZWQgYW5kIHRoZSB1c2VyIGhhcyBub3QgcHJldmlvdXNseSBhdXRob3JpemVkIGFjY2VzcywgdGhlbiB0aGUgdXNlciBpcyBzaG93biBhIGNvbnNlbnQgc2NyZWVuLlxyXG4gICovXHJcbiAgcHJvbXB0Pzogc3RyaW5nO1xyXG4gIC8qXHJcbiAgICBUaGUgZW1haWwsIG9yIFVzZXIgSUQsIG9mIGEgdXNlciB0byBwcmUtc2VsZWN0IGluIHRoZSBzaWduLWluIGZsb3cuIFxyXG4gICAgVGhpcyBpcyBzdXNjZXB0aWJsZSB0byBtb2RpZmljYXRpb24gYnkgdGhlIHVzZXIsIHVubGVzcyBwcm9tcHQ6IFwibm9uZVwiIGlzIHVzZWQuXHJcbiAgKi9cclxuICBsb2dpbl9oaW50Pzogc3RyaW5nO1xyXG5cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlQ29uZmlnIHtcclxuICBsYXp5TG9hZCA9IGZhbHNlO1xyXG4gIHByb3ZpZGVyczogTWFwPHN0cmluZywgTG9naW5Qcm92aWRlcj4gPSBuZXcgTWFwPHN0cmluZywgTG9naW5Qcm92aWRlcj4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJvdmlkZXJzOiBBdXRoU2VydmljZUNvbmZpZ0l0ZW1bXSkge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm92aWRlcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgbGV0IGVsZW1lbnQgPSBwcm92aWRlcnNbaV07XHJcbiAgICAgIHRoaXMucHJvdmlkZXJzLnNldChlbGVtZW50LmlkLCBlbGVtZW50LnByb3ZpZGVyKTtcclxuICAgICAgdGhpcy5sYXp5TG9hZCA9IHRoaXMubGF6eUxvYWQgfHwgZWxlbWVudC5sYXp5TG9hZDtcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlIHtcclxuXHJcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgRVJSX0xPR0lOX1BST1ZJREVSX05PVF9GT1VORCA9ICdMb2dpbiBwcm92aWRlciBub3QgZm91bmQnO1xyXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEVSUl9OT1RfTE9HR0VEX0lOID0gJ05vdCBsb2dnZWQgaW4nO1xyXG5cclxuICBwcml2YXRlIHByb3ZpZGVyczogTWFwPHN0cmluZywgTG9naW5Qcm92aWRlcj47XHJcblxyXG4gIHByaXZhdGUgX3VzZXI6IFNvY2lhbFVzZXIgPSBudWxsO1xyXG4gIHByaXZhdGUgX2F1dGhTdGF0ZTogUmVwbGF5U3ViamVjdDxTb2NpYWxVc2VyPiA9IG5ldyBSZXBsYXlTdWJqZWN0KDEpO1xyXG4gIHByaXZhdGUgX3JlYWR5U3RhdGU6IEJlaGF2aW9yU3ViamVjdDxzdHJpbmdbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcclxuXHJcbiAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xyXG5cclxuICBnZXQgYXV0aFN0YXRlKCk6IE9ic2VydmFibGU8U29jaWFsVXNlcj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2F1dGhTdGF0ZS5hc09ic2VydmFibGUoKTtcclxuICB9XHJcbiAgLyoqIFByb3ZpZGVzIGFuIGFycmF5IG9mIHByb3ZpZGVyIElEJ3MgYXMgdGhleSBiZWNvbWUgcmVhZHkgKi9cclxuICBnZXQgcmVhZHlTdGF0ZSgpOiBPYnNlcnZhYmxlPHN0cmluZ1tdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5fcmVhZHlTdGF0ZS5hc09ic2VydmFibGUoKTtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogQXV0aFNlcnZpY2VDb25maWcpIHtcclxuICAgIHRoaXMucHJvdmlkZXJzID0gY29uZmlnLnByb3ZpZGVycztcclxuXHJcbiAgICBpZiAoIWNvbmZpZy5sYXp5TG9hZCkge1xyXG4gICAgICB0aGlzLmluaXRpYWxpemUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZSgpIHtcclxuICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gICAgdGhpcy5wcm92aWRlcnMuZm9yRWFjaCgocHJvdmlkZXI6IExvZ2luUHJvdmlkZXIsIGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHByb3ZpZGVyLmluaXRpYWxpemUoKS50aGVuKCgpID0+IHtcclxuICAgICAgICBsZXQgcmVhZHlQcm92aWRlcnMgPSB0aGlzLl9yZWFkeVN0YXRlLmdldFZhbHVlKCk7XHJcbiAgICAgICAgcmVhZHlQcm92aWRlcnMucHVzaChrZXkpO1xyXG4gICAgICAgIHRoaXMuX3JlYWR5U3RhdGUubmV4dChyZWFkeVByb3ZpZGVycyk7XHJcblxyXG4gICAgICAgIHByb3ZpZGVyLmdldExvZ2luU3RhdHVzKCkudGhlbigodXNlcikgPT4ge1xyXG4gICAgICAgICAgdXNlci5wcm92aWRlciA9IGtleTtcclxuXHJcbiAgICAgICAgICB0aGlzLl91c2VyID0gdXNlcjtcclxuICAgICAgICAgIHRoaXMuX2F1dGhTdGF0ZS5uZXh0KHVzZXIpO1xyXG4gICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICAgIHRoaXMuX2F1dGhTdGF0ZS5uZXh0KG51bGwpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2lnbkluKHByb3ZpZGVySWQ6IHN0cmluZywgb3B0PzogTG9naW5PcHQpOiBQcm9taXNlPFNvY2lhbFVzZXI+IHtcclxuICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xyXG4gICAgICB0aGlzLmluaXRpYWxpemUoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIGxldCBwcm92aWRlck9iamVjdCA9IHRoaXMucHJvdmlkZXJzLmdldChwcm92aWRlcklkKTtcclxuICAgICAgaWYgKHByb3ZpZGVyT2JqZWN0KSB7XHJcbiAgICAgICAgcHJvdmlkZXJPYmplY3Quc2lnbkluKG9wdCkudGhlbigodXNlcjogU29jaWFsVXNlcikgPT4ge1xyXG4gICAgICAgICAgdXNlci5wcm92aWRlciA9IHByb3ZpZGVySWQ7XHJcbiAgICAgICAgICByZXNvbHZlKHVzZXIpO1xyXG5cclxuICAgICAgICAgIHRoaXMuX3VzZXIgPSB1c2VyO1xyXG4gICAgICAgICAgdGhpcy5fYXV0aFN0YXRlLm5leHQodXNlcik7XHJcbiAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlamVjdChBdXRoU2VydmljZS5FUlJfTE9HSU5fUFJPVklERVJfTk9UX0ZPVU5EKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzaWduT3V0KHJldm9rZTogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xyXG4gICAgICB0aGlzLmluaXRpYWxpemUoKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAoIXRoaXMuX3VzZXIpIHtcclxuICAgICAgICByZWplY3QoQXV0aFNlcnZpY2UuRVJSX05PVF9MT0dHRURfSU4pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCBwcm92aWRlcklkID0gdGhpcy5fdXNlci5wcm92aWRlcjtcclxuICAgICAgICBsZXQgcHJvdmlkZXJPYmplY3QgPSB0aGlzLnByb3ZpZGVycy5nZXQocHJvdmlkZXJJZCk7XHJcbiAgICAgICAgaWYgKHByb3ZpZGVyT2JqZWN0KSB7XHJcbiAgICAgICAgICBwcm92aWRlck9iamVjdC5zaWduT3V0KHJldm9rZSkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX3VzZXIgPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLl9hdXRoU3RhdGUubmV4dChudWxsKTtcclxuICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVqZWN0KEF1dGhTZXJ2aWNlLkVSUl9MT0dJTl9QUk9WSURFUl9OT1RfRk9VTkQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=